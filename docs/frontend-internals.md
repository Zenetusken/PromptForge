# Frontend Internals

Detailed reference for frontend stores, shared utilities, key components, and routing. Read the source files for the latest API — this doc provides orientation and intent, not exhaustive signatures.

## Stores

Svelte 5 runes-based stores (`.svelte.ts` files in `frontend/src/lib/stores/`):

| Store | Purpose |
|-------|---------|
| `optimization.svelte.ts` | Scoped result state: `forgeResult` (from SSE pipeline) and `viewResult` (from history/detail pages) as separate slots; compatibility getter `result` returns `forgeResult ?? viewResult`. Current pipeline run state (isRunning, steps, strategyData, error). 4 steps: analyze, strategy, optimize, validate. Rolling `resultHistory[]` (last 10) for comparison workflow. Generic `_runNode()` helper for orchestration step execution. `openInIDE(result)` sets `forgeResult` and opens IDE in review mode; `openInIDEFromHistory(id)` fetches + opens (legacy, prefer `openDocument()` from `documentOpener.ts`). `restoreResult(id)` loads a result from `resultHistory` cache or server into `forgeResult` without side effects (no `enterReview`, no `openIDE`). `_attachArtifactToActiveTab(result)` attaches an `ArtifactDescriptor` + `resultId` to the active tab — called on forge completion and tournament completion. `resetForge()` clears forge-side state while preserving `viewResult`. |
| `history.svelte.ts` | History list with pagination, filtering, search. |
| `forgeSession.svelte.ts` | Unified forge session state with multi-tab workspace (`WorkspaceTab[]`, `MAX_TABS = 5` with LRU eviction). Each `WorkspaceTab` carries `{ id, name, draft, resultId, mode, document }` — `resultId` binds the tab to an optimization result; `mode` (`ForgeMode`) tracks compose/review state per tab; `document` (`FileDescriptor | null`) provides tab identity for document-aware icons and drag-and-drop. `isActive` flag for session lifecycle — set by `activate()`, `loadRequest()`, `updateDraft(text)`, `focusTextarea()`; cleared by `reset()`. All activation methods also call `windowManager.openIDE()`; `reset()` calls `windowManager.closeIDE()`. Draft text/metadata/context/strategy, tray/section open state, validation errors, auto-retry flag. `createTab()` is the centralized tab creation method — enforces `MAX_TABS` with LRU eviction, generates sequential `"Untitled N"` names filling gaps; all entry points (tab bar, Ctrl+N, command palette, Start Menu, desktop context) delegate to it. `loadRequest()` replaces entire draft (opens new tab if current has text, with its own inline tab creation for custom-named tabs), `updateDraft()` patches individual fields, `buildMetadata()` produces API payload. `sessionStorage` persistence with hydration on load. Hydration defaults missing `resultId`/`mode`/`document` fields, resets `'forging'` to `'compose'`, and validates `document` via `_hydrateDocument()` (checks `kind`/`id`/`name` fields). |
| `tabCoherence.ts` | Tab-state coordination module bridging `forgeSession`, `optimizationState`, and `forgeMachine`. `saveActiveTabState()` writes `forgeResult.id` and `forgeMachine.mode` onto the active tab (forging → compose). `restoreTabState(tab)` loads the tab's result (synchronous cache path or async server fallback with generation counter to discard stale responses during rapid switching) and sets the machine mode, or clears to compose with info toast on restore failure. Document-aware: when an artifact or sub-artifact tab's result can't be restored, its `document` field is cleared to prevent stale references. Used by `ForgeIDEEditor` tab operations, keyboard shortcuts, and layout `$effect`s. |
| `forgeMachine.svelte.ts` | Mode state machine (compose → forging → review → compare). Guarded transitions: `forge()`, `complete()`, `compare()`, `back()`, `reset()`. Teleport transitions: `enterReview()`, `enterForging()` (for direct mode changes outside normal lifecycle, e.g., "Open in IDE" or re-forge). `isMinimized` transient state with `minimize()`/`restore()`. Panel width with 3 tiers: compact (240px), standard (380px), wide (560px). Comparison slot management. Derived: `runningCount` (delegated from `processScheduler`), `widthTier`, `isCompact`. Process lifecycle fully delegated to `processScheduler` — use `processScheduler.spawn()`, `.complete()`, `.fail()` directly. **Persistence**: mode and isMinimized → sessionStorage (`pf_forge_machine`); panel width → localStorage (`pf_forge_panel_width`) so it survives browser close. Auto-migrates width from sessionStorage on first load. |
| `promptAnalysis.svelte.ts` | Client-side heuristic task type estimation and strategy recommendations. Debounced `analyzePrompt()` uses keyword patterns from `promptHeuristics.ts` + `recommendation.ts` engine. `updateFromPipeline()` accepts authoritative classification from pipeline results. |
| `provider.svelte.ts` | Provider selection, API key management (sessionStorage/localStorage), model selection, LLM header building. Health polling with MCP transition detection. |
| `projects.svelte.ts` | Project CRUD, prompt management, sidebar list. `hasLoaded`/`isLoading` guards for lazy initialization. |
| `sidebar.svelte.ts` | Tab state (history/projects) and open/closed state, both localStorage-persisted. Private `#_isOpen` backing field with getter/setter for auto-persistence through two-way bindings. Methods: `open()`, `close()`, `toggle()`, `openTo(tab)`. |
| `desktopStore.svelte.ts` | Desktop icon system: 4-tier `IconType` hierarchy (`'system'` for Forge IDE + Recycle Bin with `.app` extension, `'folder'` for Projects + History, `'file'` for `.lnk` shortcut files, `'prompt'` for DB-backed `.md` prompts). System icons have clean labels (no extension shown), shortcuts show `.lnk` extension, DB prompts show `.md` extension. `DB_PROMPT_PREFIX = 'db-prompt-'` for prompt icon IDs. `syncDbFolders()` / `syncDbPrompts()` mirror root filesystem nodes as desktop icons. `_openDbPrompt()` opens desktop prompts via `openDocument()`. `_deleteDbPrompt()` deletes from DB via `fsOrchestrator.deletePrompt()` with confirm dialog. Grid positions (`CELL_WIDTH=76`, `CELL_HEIGHT=84`, `GRID_PADDING=12`, `TASKBAR_HEIGHT=40`), selection, drag-and-drop with 5px threshold and ghost preview (column + row clamped via `getMaxCol()`/`getMaxRow()`), double-drag guard (discards stale drag), right-click context menus (icon-specific + desktop background; folders/files/prompts get Rename + Delete; system icons do not), recycle bin (trash/restore/permanent-delete/empty for folder + file icons; `sourceType` tracks `'folder' \| 'file'`; `restoreItem()` returns `true` when placed off-screen), inline rename (`renameIcon()` — non-system only, trims/rejects empty, persists custom labels), sort (by name or by type using `TYPE_SORT_ORDER` from `fileTypes.ts`: system → folder → shortcut → file/prompt; cancels active drag), reset, `reclampPositions()` (called on window resize — clamps all icons to viewport bounds, deduplicates overlaps via `_dedupPositions()`). **Unified grid orchestration**: `_autoLayout(icons)` is the single authoritative layout algorithm — assigns all positions column-first with Recycle Bin reserved at bottom-left `(0, maxRow)`. Used by `resetDesktop()`, first load, and `sortIcons()`. `_findEmptyCell()` handles incremental single-icon placement (e.g., `restoreItem()`). `_dedupPositions()` repairs overlaps after clamping. Derived: `gridFull` (true when icon count >= total grid cells). `requestRename` signal enables context-menu → surface communication. Persistence via localStorage (`pf_desktop` key) so desktop customization survives browser close; auto-migrates from sessionStorage on first load. Persisted data includes `customLabels` (only labels differing from defaults); persisted key `removedShortcuts` retained for backward compat but tracks all non-system icon removals. Init loads persistence with column + row clamping and overlap dedup; fresh start runs `_autoLayout`. Action dispatch routes to other stores via dynamic imports. |
| `snapLayout.ts` | Snap layout system — zone detection, layout catalog, geometry resolution, magnetic edge snapping. Types: `SnapZoneId`, `SnapSlotId`, `SnapZone`, `LayoutSlot`, `SnapLayout`, `SnapGroup`, `SnapGroupSlot`, `EdgeSnapResult`, `ResizeEdgeSnapResult`. `getViewportSize()` centralizes the viewport dimension calculation (excluding taskbar). `computeSnapZone(clientX, clientY)` detects 7 snap zones with 20px edge threshold (corners prioritized). `resolveZoneGeometry(zoneId, vw, vh)` and `resolveSlotGeometry(slot, vw, vh)` convert fractional layouts to pixel geometry. `inferLayoutFromZone(zone)` maps zones to layout+slot. `SNAP_LAYOUTS` defines 7 presets (full, 50/50, 60/40, top/bottom, left+right-stack, left-stack+right, quad-grid). `getGroupColor(groupId)` cycles through 10 neon palette colors by hash. **Magnetic edge snapping** (`EDGE_SNAP_THRESHOLD` = 12px): `getSnapCandidateWindows(allWindows, excludeId)` filters to normal-state windows with geometry. `computeEdgeSnap(draggedGeo, otherWindows, threshold?)` checks 4 edge relationships per axis (adjacent: right↔left, left↔right; alignment: left↔left, right↔right — same for vertical) with overlap guards, picks closest match per axis independently. `computeResizeEdgeSnap(geo, resizeDir, otherWindows, threshold?)` only snaps actively-resized edges, uses original edge positions for distance comparisons. |
| `windowManager.svelte.ts` | Multi-window manager for the OS metaphor desktop. Tracks `WindowEntry[]` with z-index stacking, minimize/maximize/focus state per window. **Dual-layer persistence**: sessionStorage (`pf_wm`) for session state (open windows, z-order, active window); localStorage (`pf_window_prefs`) for user preferences (`WindowPrefs`: per-window geometry, state, pre-maximize/pre-snap geometry snapshots). On close, geometry and state are saved to localStorage prefs; on reopen, saved geometry is recalled and viewport-clamped via `clampGeometry()` (`Number.isFinite()` validation + viewport bounds clamping). **3-tier restore fallback** (`_restoreGeometry`): pre-maximize snapshot → saved geometry prefs → centered default (`_ensureGeometry`). Geometry writes during drag/resize are debounced (200ms `_persistPrefs`); critical saves (close, pre-maximize) use immediate `_flushPrefs`. `moveAndResizeWindow()` batches position+size in a single update for edge-resize. IDE-specific: `ideSpawned`, `ideVisible`. Start menu: `startMenuOpen`, `openStartMenuTo(tab)`. Generic: `openWindow(opts)`, `closeWindow(id)`, `focusWindow(id)`, `minimizeWindow(id)`, `getWindow(id)`, `updateWindowTitle(id, title)`. Convenience openers: `openIDE()`, `openProjectsWindow()`, `openHistoryWindow()`, `focusDashboard()`. **Persistent windows**: exported `PERSISTENT_WINDOW_IDS: Set<string>` — windows that persist independently of routes; used by `TaskbarWindowButton` for minimize-vs-close click logic. **Breadcrumbs**: `BreadcrumbSegment` interface. Methods: `setBreadcrumbs(id, segments)`, `getBreadcrumbs(id)`. **Navigation**: `WindowNavigation` interface. Methods: `setNavigation(id, nav)`, `getNavigation(id)`, `clearNavigation(id)`. **Snap layouts**: State: `snapGroups`, `activeSnapZone`, `snapAssistActive/LayoutId/FilledSlots`, `layoutPickerWindowId`, `hoveredSnapGroupId`. Methods: `setActiveSnapZone(zone)`, `snapWindowToZone(windowId, zone)`, `snapActiveWindow(zoneId)`, `assignToSlot(windowId, layoutId, slotId)`, `createSnapGroup(layoutId, assignments[])`, `unsnapWindow(windowId)`, `unsnapGroup(groupId)`, `unsnapAll()`, `isWindowLocked(windowId)`, `getSnapGroup(windowId)`, `getGroupSiblings(windowId)`, `openLayoutPicker/closeLayoutPicker`, `startSnapAssist/dismissSnapAssist/completeSnapAssist`. Pre-snap geometry saved before zone assignment; unsnap restores via 3-tier fallback. Snap groups persisted to sessionStorage with pruning on hydrate. `WindowEntry` extended with `snapGroupId?` and `snapSlotId?`. |
| `filesystemOrchestrator.svelte.ts` | Hierarchical folder state manager. Caches folder children and breadcrumb paths. Queries: `getChildren(parentId)`, `loadChildren(parentId)`, `getPath(projectId)`, `loadTree(rootId?)`. Mutations: `createFolder(name, parentId)`, `move(type, id, newParentId)`, `renameFolder(id, newName)`, `deleteFolder(id)`, `deletePrompt(id)`. `validateDrop(descriptor, targetId, targetDepth)` enforces depth limits and self-drop prevention. `invalidate(parentId)` / `invalidateAll()` for cache management. All mutations emit `fs:*` bus events. Singleton: `fsOrchestrator`. |
| `toast.svelte.ts` | Toast notifications. |
| `stats.svelte.ts` | Global + project-scoped stats. `load(total)` fetches global stats when history total changes. `setContext(projectName)` loads project-scoped stats, `clearProjectContext()` reverts to global. `activeStats` getter returns context-appropriate stats (project-scoped when active, global otherwise). `reset()` clears all. Initialized in `+layout.svelte`. |
| `processScheduler.svelte.ts` | Single source of truth for forge process lifecycle. `spawn(config)` creates a process (runs immediately or queues if at capacity), `complete(id, data)` marks success with score/strategy/optimizationId, `fail(id, error?)` marks error, `cancel(id)`, `dismiss(pid)` removes from list, `updateProgress(id, stage, progress)` updates current stage. `maxConcurrent` (default 2, synced from settings store) limits parallel forges. Bounded to 5 total processes with LRU eviction of oldest completed. Derived: `queue`, `running`, `completed`, `runningCount`, `canSpawn`, `activeProcess`. Rate-limit aware via `provider:rate_limited` bus events — pauses promotion while rate-limited. Persisted to sessionStorage; running processes hydrate as `'error'` (callbacks can't be serialized). |
| `settings.svelte.ts` | Persisted user preferences backed by localStorage. Properties: `accentColor` (`NeonColor`), `defaultStrategy` (string), `maxConcurrentForges` (number), `enableAnimations` (boolean), `autoRetryOnRateLimit` (boolean), `wallpaperMode` (`WallpaperMode`: `'static'`/`'subtle'`/`'dynamic'`), `wallpaperOpacity` (number, 0.05–0.35), `performanceProfile` (`PerformanceProfile`: `'low'`/`'balanced'`/`'high'`/`'custom'`). Methods: `update(partial)` merges a partial settings object, auto-detects performance profile from governed fields, persists, and applies CSS variables; `reset()` restores all defaults; `applyPreset(profile)` patches all governed fields (wallpaperMode + wallpaperOpacity + enableAnimations) in one call. Derived: `detectedProfile` (compares current settings against preset definitions). Exports `NEON_COLORS` (array of valid accent color values), `NEON_COLOR_HEX` (hex map for color swatch rendering). Drives CSS custom properties `--accent-color` and `--wallpaper-opacity` on `:root`. |

## Services

Located in `frontend/src/lib/services/`:

| Service | Purpose |
|---------|---------|
| `systemBus.svelte.ts` | Decoupled inter-component communication bus. Typed event namespaces: `forge:*` (start/complete/error/cancel), `window:*` (open/close/focus/minimize), `clipboard:copied`, `provider:*` (change/error), `history:reload`, `stats:reload`, `notification:show`, `mcp:*` (tool_start/tool_progress/tool_complete/tool_error/session_connect/session_disconnect), `snap:*` (created/dissolved/window_added/window_removed), `workspace:*` (synced/error/connected/disconnected). API: `emit(type, source, payload)` dispatches an event with source attribution, `on(type, handler)` subscribes and returns an unsubscribe function, `once()` for single-fire subscriptions, wildcard `'*'` listener receives all events. Tracks `recentEvents` (rolling buffer, max 50) for debugging and the terminal monitor. |
| `notificationService.svelte.ts` | System notification manager. Notification types: `info`, `success`, `warning`, `error`. Each notification carries title, body, type, read/unread status, timestamp, persistent flag, and optional action callback. Max 50 notifications with oldest-first eviction. Methods: `notify(config)`, `dismiss(id)`, `markRead(id)`, `markAllRead()`, `clear()`. `subscribeToBus()` registers 10 event handlers: `forge:completed/failed/cancelled`, `tournament:completed`, `provider:rate_limited/unavailable`, `mcp:tool_complete/tool_error`, `mcp:session_connect` (success notification), `mcp:session_disconnect` (persistent error notification), `notification:show` (generic channel). "Open in IDE" action callbacks use `openArtifactInIDE()` helper (dynamic imports of `documentOpener`, `fileDescriptor`, `fileTypes` to avoid circular deps). MCP server availability changes (from provider health polling) flow through the bus into persistent tray notifications. |
| `clipboardService.svelte.ts` | Clipboard operations with history tracking. `copy(text, label?)` writes to the system clipboard and pushes to an internal history stack (max 10 entries). Emits `clipboard:copied` on the system bus with the copied content. Fallback textarea method for environments where `navigator.clipboard` is unavailable. History entries include text, optional label, and timestamp. |
| `commandPalette.svelte.ts` | Fuzzy-matched command registry with keyboard activation (`Ctrl+K` / `Cmd+K`). Commands registered with `id`, `label`, `category`, `action`, and optional `shortcut`/`icon`. Categories group commands in the palette UI (e.g., Forge, Window, Navigation, Settings). `register(command)` / `unregister(id)` for dynamic command management. Tracks recent commands for priority sorting. Fuzzy matching scores by label and category for ranked results. |
| `mcpActivityFeed.svelte.ts` | SSE client for real-time MCP server activity. Connects to `GET /api/mcp/events` and streams tool call lifecycle events with `Last-Event-ID` reconnection support (tracks last received event ID, sends it as a header on reconnect for gap-free replay). Reactive state: `connected` (SSE connection status), `events` (recent events, newest first, max 100), `activeCalls` (in-flight tool calls with `call_id`, `tool_name`, `client_id`, `startedAt`, `progress`, `message`), `sessionCount` (connected MCP clients), `totalEventsReceived`. Auto-reconnect with exponential backoff (3s → 30s cap). Parses `mcp_status` (snapshot on connect), `mcp_activity` (live events), and `id:` (SSE protocol) event fields. 2-second snapshot phase suppresses bus event emission on connect/reconnect to prevent notification flooding. Emits parsed events on `systemBus` as `mcp:tool_start`, `mcp:tool_progress`, `mcp:tool_complete`, `mcp:tool_error`, `mcp:session_connect`, `mcp:session_disconnect`. API: `connect()` returns cleanup function, `disconnect()`, `reset()`. Exports `MCP_WRITE_TOOLS` constant (11 tools: `optimize`, `retry`, `batch`, `cancel`, `create_project`, `add_prompt`, `update_prompt`, `set_project_context`, `delete`, `bulk_delete`, `tag`) — shared by `notificationService` and `+layout.svelte` for write-tool detection. Exports `MCP_TOOL_COLORS` constant (tool name → Tailwind text color class) — shared by `NetworkMonitorWindow` and any component displaying tool-specific colors. Module-level singleton: `mcpActivityFeed`. |

## Shared Utilities

Located in `frontend/src/lib/utils/`:

| Utility | Purpose |
|---------|---------|
| `strategies.ts` | Canonical list of 10 strategy names, labels, descriptions, details (`STRATEGY_DETAILS`), and 10 unique colors (`STRATEGY_COLOR_META`). Single lookup: `getStrategyColor(name)` returns `StrategyColorMeta` with `bar`, `text`, `border`, `btnBg`, `rawRgba` fields. Cyan fallback for unknown. |
| `taskTypes.ts` | 14 task types with per-type neon colors (`TASK_TYPE_COLOR_META`). `getTaskTypeColor(name)` returns `TaskTypeColorMeta` with `text`, `chipBg`, `cssColor`, `rawRgba` fields. Dim fallback for unknown. |
| `complexity.ts` | 3-tier complexity colors with alias normalization (simple/low, moderate/medium, complex/high). `getComplexityColor(name)` returns `ComplexityColorMeta`. |
| `recommendation.ts` | Multi-signal recommendation engine for Strategy Explorer. Scores untried strategies via 4 weighted signals (task-type affinity 0.50, gap analysis 0.25, diversity 0.25) plus secondary composite (0.20) and confidence dampener. Upgrades precision when backend analytics are available (score matrix, variance, combo effectiveness). Pure functions, no side effects. |
| `stackTemplates.ts` | 8 pre-built `CodebaseContext` profiles for common stacks (SvelteKit, FastAPI, Next.js, Django, Express, Rails, Spring Boot, Go). |
| `promptParser.ts` | Pure functions for prompt text analysis: `extractVariables()` (detects `{{var}}` and `{var}` patterns with position/matchLength tracking), `detectSections()` (recognizes 7 section types: role, context, steps, constraints, examples, output, task). Used by ForgeEditor for gutter dots and variable chips. |
| `promptHeuristics.ts` | Client-side keyword-based task type estimation. Matches prompt text against patterns from `taskTypes.ts` and `strategies.ts` bestFor fields. Returns estimated task type + confidence. Used by `promptAnalysis.svelte.ts`. |
| `scoreDimensions.ts` | Score dimension definitions: `ALL_DIMENSIONS` (5: clarity, specificity, structure, faithfulness, conciseness), `DIMENSION_LABELS`, `DIMENSION_COLORS`, `DIMENSION_ABBREVS` (3-letter: CLR/SPC/STR/FTH/CNC), `DIMENSION_TOOLTIPS`, `SCORE_WEIGHTS` (0.20/0.20/0.15/0.25/0.20), `computeContribution()`, `tagFinding()`. Pipeline step dot styling via `stepDotClass()`. Supplementary dimensions: `SUPPLEMENTARY_META` (framework_adherence → "Strategy Fit", neon-orange, ADH), `ALL_SUPPLEMENTARY` array. |
| `fileTypes.ts` | OS-like file type registry. `FileExtension` union (`.md`, `.forge`, `.scan`, `.val`, `.strat`, `.tmpl`, `.app`, `.lnk`) with `FileTypeMetadata` (label, icon, color, editable, versionable). `ArtifactKind` enum (`'forge-result' \| 'forge-analysis' \| 'forge-scores' \| 'forge-strategy'`) with `ARTIFACT_KINDS` metadata. `ARTIFACT_EXTENSION_MAP` maps kinds to extensions. Helpers: `toForgeFilename(title, score, version?)`, `toSubArtifactFilename(kind)`, `toArtifactName(title, score)`, `toFilename(content)`. `TYPE_SORT_ORDER`: system(0) < folder(1) < shortcut(2) < file/prompt(3). |
| `fileDescriptor.ts` | Unified file type system for IDE documents. `FileDescriptor` discriminated union (`PromptDescriptor \| ArtifactDescriptor \| SubArtifactDescriptor \| TemplateDescriptor`). `SubArtifactDescriptor` links to a parent forge with `parentForgeId` and `artifactKind`. Factory helpers: `createPromptDescriptor()`, `createArtifactDescriptor()`, `createSubArtifactDescriptor()`. Type guards: `isPromptDescriptor()`, `isArtifactDescriptor()`, `isSubArtifactDescriptor()`, `isTemplateDescriptor()`, `isFolderDescriptor()`. `FILE_DESCRIPTOR_KINDS` constant for hydration validation. |
| `documentOpener.ts` | Single `openDocument(descriptor)` entry point for opening any document type in the IDE. Routes by descriptor kind: `openPrompt()` (fetches project, creates tab, enters review or compose; desktop prompts with empty projectId use `openDesktopPrompt()` via `GET /api/fs/prompt/{id}`), `openArtifact()` and `openSubArtifact()` both delegate to shared `openForgeResult()` helper (fetches optimization, sets result, enters review). Attaches `FileDescriptor` to `forgeSession.activeTab.document`. All entry points (HistoryWindow, ProjectsWindow, StartMenu, notifications, TaskManager, drag-and-drop, desktop icons) funnel through this function. |
| `dragPayload.ts` | Drag-and-drop payload encoding/decoding for cross-window document transfer. `DragPayload` interface with `descriptor` + `source` fields. `DRAG_MIME` (`application/x-promptforge`) custom MIME type. `encodeDragPayload()` / `decodeDragPayload()` with JSON validation and null safety. |
| `promptOpener.ts` | **Deprecated** — delegates entirely to `openDocument(createPromptDescriptor(...))` from `documentOpener.ts`. Retained for backward compatibility. |

## UI Primitives (`components/ui/`)

Barrel-exported from `components/ui/index.ts`. Import as `{ Tooltip, StatusDot } from "./ui"`.

| Component | Purpose |
|-----------|---------|
| `Tooltip` | bits-ui floating label on hover. |
| `MetaBadge` | Colored badge for strategy/task/tag/complexity values. |
| `EntryTitle` | Truncated title with fallback placeholder. |
| `Separator` | bits-ui divider line. |
| `Switch` | bits-ui toggle. |
| `SidebarTabs` | bits-ui tabbed navigation strip. |
| `WindowTabStrip` | Shared window tab bar with cyan/green accent variants. Replaces duplicated tab strips. |
| `EmptyState` | Centered empty-state placeholder (icon + message + optional submessage). |
| `StatusDot` | Rounded-full status indicator dot in 5 neon colors. |
| `InlineProgress` | Standardized `h-1` progress bar with color variants. |

## Key Components

### OS Desktop

| Component | Role |
|-----------|------|
| `DesktopSurface.svelte` | Desktop wallpaper + store-driven icon grid. Icons rendered as absolute-positioned elements at `col * CELL_WIDTH + GRID_PADDING, row * CELL_HEIGHT + GRID_PADDING`. Handles selection (click), primary action (double-click), drag with ghost preview, right-click context menu (icon or background), and inline rename flow. Document-level `mouseup`/`mouseleave` listeners end drag even when mouse leaves the surface. Debounced (250ms) window `resize` listener calls `desktopStore.reclampPositions()`. Renders `DesktopContextMenu` and drag ghost overlay. Action dispatch: `sys-forge-ide` opens IDE, `sys-projects` and `sys-history` open dedicated `DesktopWindow`s via `windowManager.openProjectsWindow()`/`openHistoryWindow()` (not the Start Menu), `sys-recycle-bin` opens recycle bin window. |
| `DesktopIcon.svelte` | Individual icon button with label. Props: `id`, `icon`, `label`, `color`, `selected`, `dragging`, `binIndicator`, `binEmpty`. Events: `onselect`, `ondblclick`, `oncontextmenu`, `onmousedown`. Selection ring (`ring-1 ring-neon-cyan/30`), drag opacity, bin full/empty indicator. |
| `DesktopContextMenu.svelte` | Right-click context menu at mouse coordinates. Viewport-clamped positioning, separator-aware height. `fly` transition, deferred click-outside/Escape dismissal via `requestAnimationFrame`. Danger item styling. z-index 45. |
| `RecycleBinWindow.svelte` | Content for recycle bin window (rendered inside `DesktopWindow`). Toolbar with item count + "Empty Recycle Bin" button, scrollable item list with type icons and hover-reveal restore/delete buttons, empty state, two local `ConfirmModal` instances. |
| `ProjectsWindow.svelte` | Content for projects window (rendered inside `DesktopWindow`). Toolbar with item count, debounced search, active/archived filter toggle. Scrollable project rows with context-profile dot, prompt count, timestamps. Load-more pagination and search-aware empty state. Follows RecycleBinWindow pattern. |
| `HistoryWindow.svelte` | Content for history window (rendered inside `DesktopWindow`). Toolbar with item count, search, sort dropdown (newest/score). Scrollable history rows with color-coded score badges, task type, project name, timestamps. Rows have `dragPayload` with `ArtifactDescriptor` for drag-and-drop to IDE. Double-click opens via `openDocument()`. Load-more pagination and search-aware empty state. Follows RecycleBinWindow pattern. |
| `FolderWindow.svelte` | Content for folder window (rendered inside `DesktopWindow`). Breadcrumb navigation, folder + prompt listing with `.md` extensions on prompt names. Forge count badge on prompts. Expandable forge children per prompt with `.forge` extension rows. Drag-and-drop move support. Uses `fsOrchestrator` for data fetching and mutations. |
| `DesktopWindow.svelte` | Draggable/resizable window chrome with title bar, minimize/maximize/close buttons, z-index stacking via `windowManager`. Renders breadcrumb address bar. Snap integration: viewport zone detection during drag (`computeSnapZone`), magnetic edge snapping to nearby windows during drag (`computeEdgeSnap`, viewport zones take priority) and resize (`computeResizeEdgeSnap`), lock guards, lock icon, layout picker hover trigger (300ms), title bar context menu with snap actions. |
| `SnapPreview.svelte` | Translucent zone preview overlay during drag. z-index 9. Uses Svelte `fade` transition. |
| `SnapAssist.svelte` | Post-snap overlay for filling remaining layout zones. Clickable window cards (max 4 per zone), auto-dismiss on empty candidates, reactive viewport via `svelte:window` bindings. z-index 15. |
| `SnapLayoutPicker.svelte` | Layout thumbnail popover (7 presets, 64×44px each) on maximize button hover. Flex-wrap layout with shared hover label (no per-item labels or browser tooltips). |
| `DesktopTaskbar.svelte` | Bottom taskbar with Start button, window buttons per open window, system tray. |
| `StartMenu.svelte` | Start menu overlay with history/projects views, new forge/project actions. Recent forges open via `openDocument(createArtifactDescriptor(...))`. |

### Layout & Navigation

| Component | Role |
|-----------|------|
| `ForgeIDEWorkspace.svelte` | Full-width 3-pane IDE overlay. Renders ForgeIDEExplorer (left), ForgeIDEEditor (center), ForgeIDEInspector (right). Route-independent: shown when `windowManager.ideVisible && !forgeMachine.isMinimized`. Opens via `fly` transition. |
| `ForgeMinimizedBar.svelte` | Slim status bar shown when IDE is minimized during forging/review/compare (`forgeMachine.showMinimizedBar`). Three mode renders: forging (step dots + timer + cancel), review (score + strategy badge), compare (label). Expand calls `windowManager.openIDE()` (no navigation). Reads `forgeResult` for review display. Persists across routes. |
| `ForgeTaskbar.svelte` | Horizontal process strip shown on dashboard when IDE is hidden and processes exist. Each button: status dot (pulse/score/error), truncated title, strategy badge. Click running: opens IDE + restores. Click completed: loads cached result via `openInIDE()`. Dismiss button on non-running processes. |
| `ForgeIDEExplorer.svelte` | Left pane (256px): collapsible context/assets section showing code snippet entries, metadata inputs (title/project/version). |
| `ForgeIDEEditor.svelte` | Center pane (flex-1): multi-tab workspace with tab bar (add/close/switch tabs, document-aware icons, drag-and-drop target), ForgeEditor in each tab. |
| `ForgeIDEInspector.svelte` | Right pane (320px): strategy selector with heuristic recommendations (spinner during analysis, "type more" hint when no recommendations yet), Analyze Only / Full Optimization action buttons, pipeline step inspector with status icons and timing, score display, error panel. Uses `optimizationState.runNodeAnalyze()` for ad-hoc single-step execution. |
| `Header.svelte` | Sticky glass header with sidebar toggle and `HeaderStats` bar. |
| `HeaderStats.svelte` | Wing formation stats bar via CSS grid (`1fr auto 1fr`): all content inside the grid so `1fr` columns guarantee true centering. Left wing (FORGED, AVG) in col 1 with `justify-self: start`, center task type chip in col 2, right wing (IMP, PROJ, TODAY + dimension mini-bars at `lg:`) in col 3 with `justify-self: end`. Center chip uses pulsating letter-contour stroke (`-webkit-text-stroke` + `header-contour-pulse` animation, color from task type). Context-aware: shows project name label when `statsState.activeProject` is set. Accepts `sidebarOpen` prop to pad left wing when sidebar toggle is visible. Reads from `statsState.activeStats`. Responsive: center only on mobile, adds wings progressively at `sm:`/`md:`/`lg:`. |
| `HistorySidebar.svelte` | Left sidebar with tabbed history/projects views. Bound to `sidebarState.isOpen`. Shows "Running Forges" section above history list when `forgeMachine.runningCount > 0` with pulse indicators and click-to-restore. |
| `Breadcrumbs.svelte` | Glass pill breadcrumb trail with monospace typography, `/` separators, sharp neon-cyan hover effect. Currently unused (was used by removed detail pages); retained for potential reuse. |

### Home Page

| Component | Role |
|-----------|------|
| `OnboardingHero.svelte` | 3-step workflow guide (Write/Forge/Iterate). Dismissible via localStorage. Shows for < 5 total forges. |
| `RecentForges.svelte` | Last 6 optimizations as navigational cards (score, task type, strategy, time). IDE-aware: when IDE is visible, cards render as `<button>` elements that load results directly into IDE via `openInIDEFromHistory()`; when IDE is hidden, cards also open in IDE via `openInIDEFromHistory()`. Uses `{#snippet cardBody()}` for shared card content. "View all" opens sidebar history tab. |
| `RecentProjects.svelte` | Up to 4 active projects as navigational cards (prompt count, context dot, description). Uses `onMount` (not `$effect`) to avoid infinite retry. "View all" opens sidebar projects tab. |
| `StrategyInsights.svelte` | Interactive Strategy Explorer with distribution bars, recommendation engine, expandable detail panels. Accepts `onStrategySelect` callback for strategy pre-fill. |

### Forge & Input

| Component | Role |
|-----------|------|
| `ForgeEditor.svelte` | Prompt textarea with slash-command autocomplete (`/strategy`), structure gutter dots (section markers), and variable chips. Used inside `ForgeIDEEditor` tabs. Uses `promptParser.ts` for real-time analysis. |
| `ForgeMetadataSection.svelte` | Title, project selector, tags, version fields. Rendered in `ForgeIDEExplorer` (left pane). Accepts `compact` prop. |
| `ForgeContextSection.svelte` | Codebase context editor with stack template picker. Auto-populates from project profile. Rendered in `ForgeIDEExplorer`. |
| `ForgeStrategySection.svelte` | Strategy override picker + secondary framework selector. Rendered in `ForgeIDEInspector` (right pane). |
| `ForgeAnalysisPreview.svelte` | Quick analysis preview in inspector: task type, complexity, strengths, weaknesses. |
| `ForgeReview.svelte` | IDE review panel: score header with dimension bars, optimized/original tabs, strategy reasoning, iteration timeline, action buttons (Copy/Iterate/Re-forge/Compare/Pop-out). |
| `ForgeCompare.svelte` | Two-column comparison: Slot A (reference) vs Slot B (current), per-dimension score delta bars, Keep A/Keep B/Back actions. Auto-widens panel to 560px. Async server fallback fetches missing slots from API when `resultHistory` cache misses (e.g., after page reload), with staleness guards to prevent race conditions and loading/error/empty UI states. |
| `ForgeError.svelte` | Shared error display with retry countdown and optional auto-retry. Reads from `optimizationState` and `forgeSession`. |
| `ContextProfileEditor.svelte` | Context profile editor. 9 fields, stack template picker, dirty detection, save/clear, readonly for archived. Currently unused (was used by removed project detail page); retained for future ProjectsWindow integration. |

### History & Results

| Component | Role |
|-----------|------|
| `HistoryEntry.svelte` | Sidebar card with IDE-aware primary click target: `<button>` calling `openInIDEFromHistory()`. Hover overlay with Re-forge/Edit/Delete actions. Delete confirmation bar. |
| `ResultPanel.svelte` | Full optimization result display (tabs: Optimized/Diff/Original, metadata, actions). |
| `ResultActions.svelte` | Copy/export/re-forge (with process tracking via `processScheduler.spawn()` + `forgeMachine.forge()`)/iterate (with full metadata passthrough) action buttons. "Open in IDE" button shown when IDE is not visible. "View Project" button opens ProjectsWindow via `navigateToProject()`. Currently unused (was used by removed detail page); retained for potential reuse. |

## Routes

| Route | Content |
|-------|---------|
| `/` | Content dashboard — the only route. The desktop surface (wallpaper + icons) is the base layer. All project/forge interactions happen through persistent windows (ProjectsWindow, HistoryWindow) and the IDE. |

The IDE renders as a route-independent overlay controlled by `windowManager`. When `windowManager.ideVisible` is true and `forgeMachine.isMinimized` is false, `+layout.svelte` shows `ForgeIDEWorkspace` (full-width 3-pane IDE: Explorer, Editor, Inspector) with a `fly` transition. The IDE opens when the user clicks "New Forge", presses `/`, clicks a template card, uses "Open in IDE" on sidebar/recent cards, or loads a prompt from projects. Closing the last tab calls `reset()` which deactivates and returns to the dashboard.

During forging/review/compare, users can minimize the IDE via minimize buttons or `Ctrl/Cmd+M`, which replaces it with `ForgeMinimizedBar`. When the IDE is hidden and processes exist, `ForgeTaskbar` shows a horizontal strip of process buttons. Keyboard shortcuts: `Ctrl/Cmd+M` toggles minimize, `Escape` dismisses snap assist/layout picker → close start menu → restore IDE → close IDE (compose), `/` restores and focuses textarea, `Ctrl/Cmd+N` creates new tab, `Ctrl/Cmd+W` closes current tab, `Alt+Arrow` snaps active window (left/right/maximize/restore), `Ctrl+Alt+Arrow` snaps to top quadrants, `Ctrl+Alt+Shift+Arrow` snaps to bottom quadrants. Command palette commands: Snap Window Left/Right, Snap Layouts..., Unsnap Window, Unsnap All, Tile All (Grid/Columns).

A desync guard `$effect` resets `forgeMachine` when both `forgeSession.isActive` and `windowManager.ideSpawned` are false but the machine is in a non-compose mode — this prevents stale states without interfering with "Open in IDE" flows that set the machine to review without activating the session.
