services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - promptforge-data:/app/data
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./data/promptforge.db
      - FRONTEND_URL=http://localhost:5199
      - AUTH_TOKEN=${AUTH_TOKEN:-}
      - INTERNAL_WEBHOOK_SECRET=${INTERNAL_WEBHOOK_SECRET:-}
      - MCP_HOST=mcp
      - RATE_LIMIT_RPM=${RATE_LIMIT_RPM:-60}
      - RATE_LIMIT_OPTIMIZE_RPM=${RATE_LIMIT_OPTIMIZE_RPM:-10}
      - LLM_PROVIDER=${LLM_PROVIDER:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-opus-4-6}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4.1}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-pro}
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=http://localhost:8000
        - VITE_AUTH_TOKEN=${AUTH_TOKEN:-}
    ports:
      - "5199:5199"
    environment:
      - ORIGIN=http://localhost:5199
    depends_on:
      backend:
        condition: service_healthy
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:5199/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  mcp:
    build:
      context: ./backend
      dockerfile: Dockerfile
    # MCP server is consumed by other containers and localhost only.
    # Uncomment the port mapping below if you need external MCP access
    # (e.g., Claude Code on a remote machine):
    # ports:
    #   - "8001:8001"
    volumes:
      - promptforge-data:/app/data
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./data/promptforge.db
      - LLM_PROVIDER=${LLM_PROVIDER:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-opus-4-6}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4.1}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-pro}
      - MCP_AUTH_TOKEN=${MCP_AUTH_TOKEN:-}
      - INTERNAL_WEBHOOK_SECRET=${INTERNAL_WEBHOOK_SECRET:-}
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    command: ["python", "-m", "uvicorn", "app.mcp_server:app", "--host", "0.0.0.0", "--port", "8001"]

volumes:
  promptforge-data:
