services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - promptforge-data:/app/data
    environment:
      - DATABASE_URL=sqlite+aiosqlite:////app/data/promptforge.db
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:5199}
      - AUTH_TOKEN=${AUTH_TOKEN:-}
      - INTERNAL_WEBHOOK_SECRET=${INTERNAL_WEBHOOK_SECRET:-}
      - MCP_HOST=mcp
      - RATE_LIMIT_RPM=${RATE_LIMIT_RPM:-60}
      - RATE_LIMIT_OPTIMIZE_RPM=${RATE_LIMIT_OPTIMIZE_RPM:-10}
      - LLM_PROVIDER=${LLM_PROVIDER:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-opus-4-6}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4.1}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-pro}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      - GITHUB_REDIRECT_URI=${GITHUB_REDIRECT_URI:-http://localhost:8000/api/apps/promptforge/github/callback}
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/apps/promptforge/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 4G

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=http://localhost:8000
        # Auth token is NOT baked into the image â€” it would be visible in the
        # JS bundle and Docker image history. For authenticated Docker deploys,
        # use a reverse proxy that injects the token or configure auth at the
        # network level.
    ports:
      - "5199:5199"
    environment:
      - ORIGIN=http://localhost:5199
    depends_on:
      backend:
        condition: service_healthy
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:5199/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 512M

  mcp:
    build:
      context: ./backend
      dockerfile: Dockerfile
    # MCP server is consumed by other containers and localhost only.
    # Uncomment the port mapping below if you need external MCP access
    # (e.g., Claude Code on a remote machine):
    # ports:
    #   - "8001:8001"
    expose:
      - "8001"
    volumes:
      - promptforge-data:/app/data
    environment:
      - DATABASE_URL=sqlite+aiosqlite:////app/data/promptforge.db
      - LLM_PROVIDER=${LLM_PROVIDER:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-opus-4-6}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4.1}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-pro}
      - MCP_AUTH_TOKEN=${MCP_AUTH_TOKEN:-}
      - INTERNAL_WEBHOOK_SECRET=${INTERNAL_WEBHOOK_SECRET:-}
      - BACKEND_HOST=backend
    depends_on:
      backend:
        condition: service_healthy
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 2G
    command: ["python", "-m", "uvicorn", "apps.promptforge.mcp_server:app", "--host", "0.0.0.0", "--port", "8001"]

volumes:
  promptforge-data:
